<!-- index.html -->
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Code Beautifier</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css">
  <style>
    /* ... (TWÃ“J STYL CSS BEZ ZMIAN â€” PRZYCIÄ˜TE DLA CZYTELNOÅšCI) ... */
  </style>
</head>
<body>
  <header>
    <img src="/static/logo.png" alt="logo">
  </header>
  <div class="container">
    <div style="flex: 1; display: flex; flex-direction: column;">
      <div id="editor" style="flex: 1; min-height: 600px;"></div>

      <!-- Formularz uploadu pliku .py -->
      <form id="uploadForm" enctype="multipart/form-data" style="margin-top: 10px;">
        <label for="file">lub przeÅ›lij plik .py:</label>
        <input type="file" id="file" name="file" accept=".py">
        <button type="submit" style="margin-top: 10px;">ZaÅ‚aduj plik</button>
      </form>
    </div>

    <div class="output">
      <button onclick="analyzeCode()">Uruchom i Przeanalizuj</button>
      <h2>Wynik:</h2>
      <pre id="output"></pre>
      <h2>BÅ‚Ä™dy:</h2>
      <pre id="error"></pre>
      <h2>AI Feedback:</h2>
      <pre id="ai"></pre>
      <button onclick="applyFixes()">Zastosuj poprawki AI</button>
    </div>
  </div>

  <!-- PrzeÅ‚Ä…cznik motywu i chat box â€“ bez zmian -->
  <div class="theme-toggle">
    <label class="switch">
      <input type="checkbox" id="themeSwitch" onchange="toggleTheme()" />
      <span class="slider"></span>
    </label>
  </div>
  <button id="chat-button">ðŸ’¬</button>
  <div id="chat-box">
    <textarea id="chat-input" placeholder="Zadaj pytanie..."></textarea>
    <button onclick="sendChat()">WyÅ›lij</button>
    <div id="chat-response"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
  <script>
    const editor = CodeMirror(document.getElementById("editor"), {
      mode: "python",
      theme: "material-darker",
      lineNumbers: true,
      tabSize: 4,
      indentUnit: 4,
      value: ""
    });

    async function analyzeCode() {
      const code = editor.getValue();
      document.getElementById('output').textContent = 'Przetwarzanie...';
      document.getElementById('error').textContent = '';
      document.getElementById('ai').textContent = '';

      const response = await fetch('/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
      });

      const data = await response.json();
      document.getElementById('output').textContent = data.stdout || '[brak wyjÅ›cia]';
      document.getElementById('error').textContent = data.error || '[brak bÅ‚Ä™dÃ³w]';
      document.getElementById('ai').textContent = data.ai_feedback || '[brak informacji od AI]';
    }

    // Upload pliku .py
    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const fileInput = document.getElementById('file');
      const file = fileInput.files[0];

      if (!file || !file.name.endsWith('.py')) {
        alert('ProszÄ™ wybraÄ‡ plik .py');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);

      const response = await fetch('/upload', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();
      if (data.code) {
        editor.setValue(data.code);
      } else {
        alert('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ pliku.');
      }
    });

    async function sendChat() {
      const prompt = chatInput.value;
      if (!prompt.trim()) return;
      chatResp.textContent = 'â³ AI myÅ›li...';
      const response = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const data = await response.json();
      chatResp.textContent = data.response;
    }

    async function applyFixes() {
      const code = editor.getValue();
      if (!code.trim()) return;

      const button = event.target;
      button.disabled = true;
      button.textContent = "AI poprawia...";

      const response = await fetch('/apply_fixes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code })
      });

      const data = await response.json();
      editor.setValue(data.fixed_code || "# Nie udaÅ‚o siÄ™ zastosowaÄ‡ poprawek");
      button.disabled = false;
      button.textContent = "Zastosuj poprawki AI";
    }

    function toggleTheme() {
      const isDark = document.getElementById("themeSwitch").checked;
      document.body.className = isDark ? "dark-mode" : "light-mode";
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    window.onload = () => {
      const saved = localStorage.getItem("theme") || "dark";
      const isDark = saved === "dark";
      document.body.className = isDark ? "dark-mode" : "light-mode";
      document.getElementById("themeSwitch").checked = isDark;
    };
  </script>
</body>
</html>
